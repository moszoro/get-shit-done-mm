---
phase: 01-constitution-foundation
plan: 02
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - src/constitution/loader.js
  - src/constitution/__tests__/loader.test.js
autonomous: true

must_haves:
  truths:
    - "Loader loads global constitution from ~/.claude/get-shit-done/CONSTITUTION.md"
    - "Loader loads project constitution from .planning/CONSTITUTION.md"
    - "Loader merges global + project with project override precedence"
    - "Loader validates version compatibility (major version must match)"
    - "Loader validates rule ID uniqueness after merge"
  artifacts:
    - path: "package.json"
      provides: "Dependencies: gray-matter, semver, deepmerge"
      contains: "gray-matter"
    - path: "src/constitution/loader.js"
      provides: "ConstitutionLoader class with load() method"
      exports: ["ConstitutionLoader"]
      min_lines: 100
    - path: "src/constitution/__tests__/loader.test.js"
      provides: "Tests for constitution loading, merging, validation"
      contains: "describe('ConstitutionLoader'"
      min_lines: 150
  key_links:
    - from: "src/constitution/__tests__/loader.test.js"
      to: "src/constitution/loader.js"
      via: "require statement"
      pattern: "require.*loader"
    - from: "src/constitution/loader.js"
      to: "gray-matter package"
      via: "require('gray-matter')"
      pattern: "require\\('gray-matter'\\)"
    - from: "src/constitution/loader.js"
      to: "global/project CONSTITUTION.md files"
      via: "fs.readFileSync with path.join"
      pattern: "readFileSync.*CONSTITUTION\\.md"
---

<objective>
Implement constitution loader using TDD approach. Loader parses YAML frontmatter + markdown, merges global and project constitutions with override precedence, validates versions and rule uniqueness.

Purpose: Core module for constitutional enforcement system. Follows red-green-refactor cycle to ensure robust parsing, merging, and validation logic.

Output: Working, tested constitution loader ready for system integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

TDD Cycle Protocol:
1. RED: Write failing test defining expected behavior
2. GREEN: Write minimal code to make test pass
3. REFACTOR: Clean up if needed (optional)
4. Commit after each cycle with pattern: test(01-02), feat(01-02), refactor(01-02)

Test execution command: `npm test` (runs tests in watch mode or single run)
</execution_context>

<context>
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/PROJECT.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/ROADMAP.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/REQUIREMENTS.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/phases/01-constitution-foundation/01-CONTEXT.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/phases/01-constitution-foundation/01-RESEARCH.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/codebase/CONVENTIONS.md

Prior work:
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/phases/01-constitution-foundation/01-01-SUMMARY.md
</context>

<feature>
  <name>Constitution Loader</name>
  <files>
    - src/constitution/loader.js (implementation)
    - src/constitution/__tests__/loader.test.js (tests)
    - package.json (dependencies)
  </files>
  <behavior>
Expected behavior in testable terms:

**Load behavior:**
- `loader.load()` with both files → merged config
- `loader.load()` with global only → global config
- `loader.load()` with project only → project config
- `loader.load()` with neither → throws error

**Parse behavior:**
- Valid YAML frontmatter → extracted version, lastUpdated
- Valid markdown sections → extracted rules by severity
- Rule format `### RULE-ID: Description` → parsed to {id, description, severity}

**Merge behavior:**
- Global + project rules → combined with project arrays replacing global arrays
- Matching rule IDs → project rule replaces global rule
- Different rule IDs → both included in result

**Version validation:**
- Global 1.0.0 + project 1.0.0 → passes
- Global 1.5.0 + project 1.2.0 → passes (same major)
- Global 2.0.0 + project 1.0.0 → throws error (major mismatch)
- Invalid semver → throws error

**Rule ID validation:**
- Unique rule IDs → passes
- Duplicate rule ID (TDD-01 in both global and project after merge) → throws error

**Path handling:**
- Uses `path.join(os.homedir(), '.claude', 'get-shit-done', 'CONSTITUTION.md')` for global
- Uses `path.join(process.cwd(), '.planning', 'CONSTITUTION.md')` for project
- No string concatenation, no hardcoded `/` separators

**RED-GREEN-REFACTOR verification:**
After writing each test: `npm test` should show 1 failing test (RED)
After implementing feature: `npm test` should show all tests passing (GREEN)
  </behavior>
  <implementation>
Implementation approach after tests pass:

**Structure:**
```javascript
class ConstitutionLoader {
  constructor() {
    this.globalPath = path.join(os.homedir(), '.claude', 'get-shit-done', 'CONSTITUTION.md');
    this.projectPath = path.join(process.cwd(), '.planning', 'CONSTITUTION.md');
  }

  load() {
    // Load files (sync during init)
    // Parse both
    // Validate versions
    // Merge with project precedence
    // Validate rule uniqueness
    // Return merged config
  }

  _readFile(filepath) { /* fs.existsSync + readFileSync */ }
  _parse(content) { /* gray-matter + regex rule extraction */ }
  _checkVersions(global, project) { /* semver validation */ }
  _merge(global, project) { /* deepmerge with array replacement */ }
  _validateRuleIds(config) { /* Set-based uniqueness check */ }
}
```

**Dependencies (add to package.json):**
```json
"dependencies": {
  "gray-matter": "^4.0.3",
  "semver": "^7.5.4",
  "deepmerge": "^4.3.1"
}
```

**Test framework:** Use existing test setup if present, otherwise create with Node.js assert or install Jest/Mocha based on project patterns.

**Anti-patterns to avoid (from RESEARCH.md):**
- NO async file loading (sync is appropriate during init)
- NO string concatenation for paths (use path.join)
- NO array concatenation for rule merging (use replacement strategy)
- NO manual version comparison (use semver.gt/lt)
- NO mutation of global config (deepmerge with clone: true)

Follow research code examples for complete implementation patterns.
  </implementation>
</feature>

<verification>
TDD cycle completed for constitution loader feature.
All tests passing: `npm test` shows 0 failures.
Test file contains >= 150 lines covering load, parse, merge, validation behaviors.
Implementation file contains >= 100 lines with ConstitutionLoader class.
Dependencies installed in package.json.
Each RED-GREEN cycle committed separately.
</verification>

<success_criteria>
- [ ] Test file created with failing tests (RED phase)
- [ ] `npm test` shows failing tests before implementation
- [ ] Implementation created making tests pass (GREEN phase)
- [ ] `npm test` shows all tests passing after implementation
- [ ] Refactored if needed (REFACTOR phase optional)
- [ ] Test suite covers all behavior cases from feature section
- [ ] ConstitutionLoader exports load() method returning merged constitution
- [ ] Code committed following test(01-02), feat(01-02) pattern
</success_criteria>

<output>
After completion, create `/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/phases/01-constitution-foundation/01-02-SUMMARY.md`
</output>
